---
- name: System updates and packages
  block:
  - name: Update package cache first
    apt:
      update_cache: yes
      cache_valid_time: 3600
    when: ansible_os_family == "Debian"
    retries: 3
    delay: 5
    become: true

  - name: Install essential packages
    apt:
      name: "{{ essential_packages }}"
      state: present
    when: ansible_os_family == "Debian"
    retries: 3
    delay: 5
    become: true

  - name: Upgrade all packages
    apt:
      upgrade: safe
      autoremove: yes
      autoclean: yes
      dpkg_options: 'force-confdef,force-confold'
    when: ansible_os_family == "Debian" and (upgrade_system | default(false))
    retries: 3
    delay: 10
    become: true
    async: 1800  # 30 minutes timeout
    poll: 30     # Check every 30 seconds


- name: Docker installation and setup
  become: true
  block:
    - name: Include Docker setup
      include_tasks: docker/docker.yml
      tags: docker

- name: Rootless user setup
  block:
    - name: Include rootless user setup
      include_tasks: rootless_user/rootless_user.yml
      tags: rootless_user